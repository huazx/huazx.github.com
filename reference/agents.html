<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>Chapter 3. 代理</title><link xmlns:xslthl="http://xslthl.sf.net" href="css/base.css" rel="stylesheet" type="text/css"><link xmlns:xslthl="http://xslthl.sf.net" href="css/style.css" rel="stylesheet" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"><link rel="start" href="index.html" title="Jolokia - Reference Documentation"><link rel="up" href="index.html" title="Jolokia - Reference Documentation"><link rel="prev" href="architecture.html" title="Chapter&nbsp;2.&nbsp;Architecture"><link rel="next" href="security.html" title="Chapter&nbsp;4.&nbsp;Security"></head><body><div class="navheader"><div>
     <div class="navbar"><a xmlns:xslthl="http://xslthl.sf.net" href="architecture.html" title="Chapter&nbsp;2.&nbsp;Architecture">上一页</a><span>|</span><a xmlns:xslthl="http://xslthl.sf.net" href="index.html" title="Jolokia - Reference Documentation">目录</a><span>|</span><a xmlns:xslthl="http://xslthl.sf.net" href="security.html" title="Chapter&nbsp;4.&nbsp;Security">下一页</a></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 xmlns:xslthl="http://xslthl.sf.net"><a name="agents"></a>Chapter&nbsp;3.&nbsp;Agents</h1></div></div></div><p>
   Jolokia是一个基于Agent的方式来访问JMX，这需要客户端安装额外的软件，这就是所谓的
    <span class="emphasis"><em>agent</em></span>。该软件需要部署在可以访问远程JMX（<a href="architecture.html#agent-mode">Section&nbsp;2.1, &#8220;Agent 模式&#8221;</a>), 器上，也可以安装在一个专用的proxy服务器（<a href="architecture.html#proxy-mode">Section&nbsp;2.2, &#8220;Proxy模式 &#8221;</a>). 式”）。对于这两种操作模式中，有四个不同的agents<sup>[<a name="d0e149" href="#ftn.d0e149">1</a>]</sup>.    
  </p><div class="variablelist"><dl><dt><span class="term"><span class="bold"><strong>Webarchive (War) agent</strong></span></span></dt><dd>
        This agent is packaged as a JEE Webarchive (War). It is the
        standard installation artifact for Java webapplications and
        probably one of the best known deployment formats. Jolokia ships
        with a war-agent which can be deployed like any other web
        application. This agent has been tested on many JEE
        servers, from well-known market leaders to rarer species.
      </dd><dt><span class="term"><span class="bold"><strong>OSGi agent</strong></span></span></dt><dd><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org" target="_top">OSGi</a> is a middleware specification
        focusing on modularity and a well defined dynamic lifecycle
        <sup>[<a name="d0e168" href="#ftn.d0e168">2</a>]</sup>.  The Jolokia OSGi agent bundles comes in two
        flavors: a minimal one with a dependency on a running
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/http/HttpService.html" target="_top">OSGi
        HttpService</a>, and a all-in-one bundle including an
        embedded <span class="emphasis"><em>HttpService</em></span> implementation
        (which is exported, too). The former is the recommended,
        puristic solution, the later is provided for a quick startup
        for initial testing the OSGi agent (but should be replaced
        with the minimal bundle for production setups).
      </dd><dt><span class="term"><span class="bold"><strong>Mule agent</strong></span></span></dt><dd><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.mulesoft.org/" target="_top">Mule</a> is one of the leading Open Source
        Enterprise Service Busses<sup>[<a name="d0e189" href="#ftn.d0e189">3</a>]</sup> (ESB). It provides a management API
        into which a dedicated Jolokia agent plugs in nicely. This
        agent includes an embedded Jetty for providing JMX HTTP
        access.
      </dd><dt><span class="term"><span class="bold"><strong>JVM agent</strong></span></span></dt><dd>
        Starting with Java 6 the JDK provided by Oracle contains a
        lightweight HTTP-Server which is used e.g. for the reference
        WebService stack implementation included in Java 6. Using 
        the Java-agent API (normally used by profilers and other
        development tools requiring the instrumentation during the
        class loading phase), the JVM 6 Jolokia agent is the most
        generic one. It is able to instrument <span class="emphasis"><em>any</em></span>
        Java application running on a Oracle JDK 6<sup>[<a name="d0e205" href="#ftn.d0e205">4</a>]</sup>.
        This Jolokia agent variant is fully featured, however tends to
        be a bit slow since the 
        provided HTTP-Server is not optimized for performance. However
        it is useful for servers like Hadoop or Teracotta, which do
        not provide convenient hooks for an HTTP-exporting agent on
        their own.
      </dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="agents-war"></a>3.1.&nbsp;JEE Agent (WAR)</h2></div></div></div><div class="section"><div class="titlepage"><div><div>
        <h3 class="title"><a name="war-agent-installation"></a>3.1.1.&nbsp;安装与配置</h3>
      </div></div></div>
      <p>
      WAR agent是目前最流行的变种，就像任何其他的JEE Web应用程序可以部署在一个servlet容器中。</p><div xmlns:xslthl="http://xslthl.sf.net" class="sidebar-border"><div class="sidebar"><p class="title"><b>Tomcat example</b></p>
      A simple example for deploying the agent on Tomcat can be found
      in the Jolokia <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.jolokia.org/tutorial.html" target="_top">quickstart</a>.
    </div></div>
      <p>    
    通常情况下，安装仅仅是简单的复制agent WAR到部署目录下。在其他平台上可以通过Web GUI或命令行工具来部署。每一个servlet容器安装的详细说明不在本文档的范围内。</p><p>
      servlet本身可以通过两种方式配置：</p><div class="variablelist"><dl><dt><span class="term"><span class="bold"><strong>Servlet的初始化参数</strong></span></span></dt>
        <dd>
        Jolokia可以在<code class="filename">WEB-INF/web.xml</code>文件的servlet定义中配置<code class="literal">init-param</code>
        声明来进行配置. 已知参数的具体说明在<a href="agents.html#agent-war-init-params" title="Table&nbsp;3.1.&nbsp;Servlet init parameters">表格&nbsp;3.1, &#8220;Servlet init parameters&#8221;</a>.  不过为了修改内部<code class="filename">web.xml</code>, agent包需要重新打包.
      </dd>
        <dt><span class="term"><span class="bold"><strong>servlet context参数</strong></span></span></dt>
        <dd>
        一个更简便的方法可能是使用servlet context参数，它可以被配置在WAR存档外。这对于每个servlet容器配置是不一样的，通常涉及到编辑配置文件，例如为<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://tomcat.apache.org/tomcat-7.0-doc/config/context.html" target="_top">Tomcat</a>，Jolokia agent的context可以将<code class="filename">jolokia.xml</code>放到<code class="filename">$TC/conf/Catalina/localhost/目录下</code>，内容如下:
        <pre class="programlisting">&lt;Context&gt; 
   &lt;Parameter name="maxDepth" value="1"/&gt; 
&lt;/Context&gt;</pre></dd></dl></div><div xmlns:xslthl="http://xslthl.sf.net" class="table">
  <p class="title"><b>表格&nbsp;3.1.&nbsp;Servlet init parameters</b></p><div class="table-contents"><table id="agent-war-init-params"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
          <td>参数</td>
          <td>描述</td>
          <td>示例</td>
        </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">dispatcherClasses</code></td>
        <td>
          <code class="constant">使用的RequestDispatcher</code>类名 (以逗号分割) <code class="constant">除LocalRequestDispatcher外</code>。调度程序使用JSR-160代理技术来调度（或‘路由’）到不同的目标。</td>
        <td>
          <code class="literal">org.jolokia.jsr160.Jsr160RequestDispatcher</code>
          (这是用于调度的JSR - 160代理)
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">policyLocation</code></td>
        <td>
          使用的策略文件的位置。 这是一个可以读取（如一个文件或http:URL）或特殊协议<code class="literal">classpath</code>：这是用来在Web应用程序的classpath中寻找该策略文件的URL。 参照
          <a href="security.html#security-policy-location">章节&nbsp;4.1.7, &#8220;Policy Location&#8221;</a> 关于这个参数的详情。 
        </td>
        <td>
          <code class="filename">file:///home/jolokia/jolokia-access.xml</code>
          for a file based access to the policy file. Default is 
          <code class="filename">classpath:/jolokia-access.xml</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">debug</code></td>
        <td>
          调试状态启动。在运行时可以通过配置MBean改变。</td>
        <td>
          Default: <code class="constant">false</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">historyMaxEntries</code></td>
        <td>
          保存在历史中的实体数. 可以通过配置MBean改变。</td>
        <td>
          Default: <code class="constant">10</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">debugMaxEntries</code></td>
        <td>
          最大实体数保持在本地调试历史（如果已启用）。在运行时可以通过改变配置的MBean。</td>
        <td>
          Default: <code class="constant">100</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">maxDepth</code></td>
        <td>
          Maximum depth when traversing bean properties.
          If set to 0, depth checking is disabled
        </td>
        <td>
          Default: <code class="constant">15</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">maxCollectionSize</code></td>
        <td>
          Maximum size of collections returned when
          serializing to JSON. When set to 0,
          collections are never truncated.
        </td>
        <td>
          Default: <code class="constant">1000</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">maxObjects</code></td>
        <td>
          Maximum number of objects which are traversed
          when serializing a single response. Use this
          as an airbag to avoid boosting your memory and
          network traffic. Nevertheless, when set to 0
          no limit is imposed.
        </td>
        <td>
          Default: <code class="constant">0</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">mbeanQualifier</code></td>
        <td>
          Qualifier to add to the ObjectName of Jolokia's own
          MBeans. This can become necessary if more than one agent is
          active within a servlet container. This qualifier is added
          to the <code class="constant">ObjectName</code> of this agent with a
          comma. For example a <code class="constant">mbeanQualifier</code>
          with the value <code class="constant">qualifier=own</code> will
          result in Jolokia server handler MBean with the name
          <code class="constant">jolokia:type=ServerHandler,qualifier=own</code>
        </td>
        <td></td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">mimeType</code></td>
        <td>
          MIME to use for the JSON responses
        </td>
        <td>
          Default: <code class="constant">text/plain</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">detectorOptions</code></td>
        <td>
          Extra options passed to an detector after successful
          detection of an application server. See below for an
          explanation. 
        </td>
        <td>          
        </td>
      </tr></table></div></div><p>
      Jolokia has various detectors which can detect the brand and
      version of an application server it is running in. This version
      is revealed with the <code class="constant">version</code> command. With
      the configuration parameter <code class="constant">detectorOptions</code>
      extra options can be passed to the detectors. These options take
      the form of a JSON object, where the keys are productnames and
      the values other JSON objects containing the specific
      configuration. This configuration is feed to a successful
      detector which can do some extra initialization on agent
      startup. Currently the following extra options are supported:
    </p><div xmlns:xslthl="http://xslthl.sf.net" class="table">
      <p class="title"><b>表格&nbsp;3.2.&nbsp;Servlet init parameters</b></p><div class="table-contents"><table id="agent-war-detector-options"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
          <td>Product</td>
          <td>Option</td>
          <td>Description</td>
        </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>glassfish</td>
        <td>bootAmx</td>
        <td>If <code class="constant">false</code> and the agent is running on
        Glassfish, this will cause the AMX subsystem not to be booted
        during startup. By default, AMX which contains all relevant
        MBeans for monitoring Glassfish is booted.
        </td>
      </tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="agent-war-security"></a>3.1.2.&nbsp;Security Setup</h3></div></div></div><p>
      In order use JEE security within the war, some extrat
      configuration steps are required within
      <code class="filename">web.xml</code>.</p><div xmlns:xslthl="http://xslthl.sf.net" class="sidebar-border"><div class="sidebar"><p class="title"><b>Using jmx4perl's <code class="literal">jolokia</code> tool</b></p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.jmx4perl.org" target="_top">jmx4perl</a> comes
      with a nice command line utility called <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://search.cpan.org/~roland/jmx4perl/scripts/jolokia" target="_top">jolokia</a>
      which allows for an easy setup of security within a given
      <code class="filename">jolokia.war</code>. See <a href="tools.html#tools-jmx4perl">Section&nbsp;9.1, &#8220;Jmx4Perl&#8221;</a> for
      more details.
    </div></div><p>
    There is a commented section which can serve as an example. All
    current client libraries are able to use BASIC HTTP authentication
    with user and password. The
    <code class="literal">&lt;login-config&gt;</code> should be set
    accordingly. The <code class="literal">&lt;security-constraint&gt;</code>
    specifies the URL pattern (which is in the default setup specify
    all resources provided by the Jolokia servlet) and a role name
    which is used to find the proper authentication credentials.  This
    role must be referenced outside the agent WAR within the servlet
    container, e.g. for Tomcat the role definition can be found in
    <code class="filename">$TOMCAT/config/tomcat-users.xml</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="agent-war-programmatic"></a>3.1.3.&nbsp;<a href="agents.html#agent-war-programmatic">使用Jolokia agent servlet进行编程</a></h3>
    </div></div></div>
    <p>
      Jolokia agent servlet也可以被集成到自己的Web应用中。只需要添加<code class="classname">org.jolokia.http.AgentServlet</code>类到我们自己的<code class="filename">web.xml</code>文件中。下面的示例映射agent的context<code class="literal">/jolokia</code>：</p><pre class="programlisting">
    &lt;servlet&gt;
      &lt;servlet-name&gt;jolokia-agent&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.jolokia.http.AgentServlet&lt;/servlet-class&gt;
      &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;jolokia-agent&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/jolokia/*&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    </pre>
      <p>
      当然， <a href="agents.html#agent-war-init-params" title="Table&nbsp;3.1.&nbsp;Servlet init parameters">表格&nbsp;3.1, &#8220;Servlet init parameters&#8221;</a>中所描述的任何初始化参数，也可以用在这里。
      </p><p>
      In order for this servlet definition to find the referenced
      Java class, the JAR <code class="filename">jolokia-core.jar</code> must
      be included. This jar can be found in <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://labs.consol.de/maven/repository/org/jolokia/jolokia-core" target="_top">Jolokia's maven
      resository</a>. Maven users will can declare a
      dependency on this jar artifact:
    </p><pre class="programlisting">
    &lt;project&gt;
      &lt;!-- ....  --&gt; 
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.jolokia&lt;/groupId&gt;
          &lt;artifactId&gt;jolokia-core&lt;/artifactId&gt;
          &lt;version&gt;0.90&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;

      &lt;!-- Maven repository hosting Jolokia --&gt;
      &lt;repositories&gt;
        &lt;repository&gt;
          &lt;id&gt;labs-consol-release&lt;/id&gt;
          &lt;name&gt;ConSol* Labs Repository (Releases)&lt;/name&gt;
          &lt;url&gt;http://labs.consol.de/maven/repository&lt;/url&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;
    &lt;/project&gt;</pre><p>
      The <code class="classname">org.jolokia.http.Agent</code> can be
      subclassed, too in order to provide a custom restrictor or a
      custom log handler. See <a href="security.html#security-restrictor">Section&nbsp;4.2, &#8220;Jolokia Restrictors&#8221;</a>
      for details.<sup>[<a name="d0e576" href="#ftn.d0e576">5</a>]</sup>
    </p><p>
      Also, multiple Jolokia agents can be deployed in the same JVM
      without problem. However, since the agent deploys some
      Jolokia-specific MBeans on the single
      <code class="literal">PlatformMBeansServer</code>, for multi-agent
      deployments it is important to use the
      <code class="constant">mbeanQualifier</code> init parameter to
      distinguish multiple Jolokia MBeans by adding an extra
      propery to those MBeans' names. This also needs to be done if
      multiple webapps containing Jolokia agents are deployed on
      the same JEE server. 
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="agents-osgi"></a>3.2.&nbsp;OSGi Agents</h2></div></div></div><div xmlns:xslthl="http://xslthl.sf.net" class="sidebar-border"><div class="sidebar"><p class="title"><b></b></p>There are several free implementations available of OSGi
    HttpService. This bundle has been tested with the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://wiki.ops4j.org/display/paxweb/Pax+Web" target="_top">Pax Web</a>
    and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/site/apache-felix-http-service.html" target="_top">Apache
    Felix</a> HttpService, both of which come with an embedded Jetty
    as servlet container by default.</div></div><p>
    Jolokia agents are also available as <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org" target="_top">OSGi</a> bundles. There are two
    flavors of this agent: A nearly bare agent
    <code class="filename">jolokia-osgi.jar</code> declaring all its package
    dependencies as imports in its Manifest and an all-in-one bundle
    <code class="filename">jolokia-osgi-bundle.jar</code> with minimal
    dependecies. The pure bundle fits best with the OSGi philosophy and is
    hence the recommended bundle. The all-in-one monster is good for a
    quick start since normally no additional bundles are required.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="agents-osgi-pure"></a>3.2.1.&nbsp;jolokia-osgi.jar</h3></div></div></div><p>
      This bundle depends mostly on a running <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/http/HttpService.html" target="_top">OSGi
      HttpService</a> which it uses for registering the agent
      servlet.
    </p><p>
      All package imports of this bundle are listed in <a href="agents.html#table-agents-osgi-deps" title="Table&nbsp;3.3.&nbsp;Package Imports of jolokia-osgi.jar (SB: exported by system bundle)">Table&nbsp;3.3, &#8220;Package Imports of jolokia-osgi.jar (SB: exported by system bundle)&#8221;</a>. Note that the
      <code class="classname">org.osgi.framework.*</code> and
      <code class="classname">javax.*</code> packages are typically exported
      by the system bundle, so no extra installation effort is
      required here. Whether the
      <code class="classname">org.osgi.service.*</code> interfaces are
      available depends on your OSGi container. If they are not
      provided, they can be easily fetched and installed from e.g.
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://repo1.maven.org/maven2/org/osgi/org.osgi.compendium/4.2.0/org.osgi.compendium-4.2.0.jar" target="_top">maven
      central</a>. Often the LogService interface is exported
      out of the box, but not the HttpService. You will notice any
      missing package dependency during the resolve phase while
      installing <code class="filename">jolokia-osgi.jar</code>.
    </p><div xmlns:xslthl="http://xslthl.sf.net" class="table"><p class="title"><b>Table&nbsp;3.3.&nbsp;Package Imports of jolokia-osgi.jar (SB: exported by system bundle)</b></p><div class="table-contents"><table id="table-agents-osgi-deps"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
          <td>Package</td>
          <td>SB</td>
          <td>Package</td>
          <td>SB</td>
          <td>Package</td>
          <td>SB</td>
          <td>Package</td>
          <td>SB</td>
        </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.osgi.framework</td>
        <td>X</td>
        <td>javax.servlet</td>
        <td></td>
        <td>org.w3c.dom</td>
        <td>X</td>
        <td>javax.management</td>
        <td>X</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.osgi.service.http</td>
        <td></td>
        <td>javax.servlet.http</td>
        <td></td>
        <td>org.xml.sax</td>
        <td>X</td>
        <td>javax.management.openmbean</td>
        <td>X</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.osgi.service.log</td>
        <td>?</td>
        <td>javax.naming</td>
        <td>X</td>
        <td>javax.xml.parsers</td>
        <td>X</td>
        <td>javax.management.remote</td>
        <td>X</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.osgi.util.tracker</td>
        <td>X</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr></table></div></div><p>
      This agent bundle consumes two services by default: As stated
      above, an
      <code class="classname">org.osgi.service.http.HttpService</code> which
      is used to register (deregister) the Jolokia agent as a servlet
      under the context <code class="literal">/jolokia</code> by default as soon
      as the HttpService becomes available (unavailable). Secondly, an
      <code class="classname">org.osgi.service.log.LogService</code> is used
      for logging, if available. If such a service is not registered,
      the Jolokia bundle uses the standard
      <code class="methodname">HttpServlet.log()</code> method for its
      logging needs.
    </p><p>
      The Jolokia OSGi bundle can be configured via the properties which
      typically can be configured in a global configuration file of
      the OSGi container. All properties start with the prefix
      <code class="literal">org.jolokia</code> and are listed in <a href="agents.html#table-agents-osgi-properties" title="Table&nbsp;3.4.&nbsp;Jolokia Bundle Properties">Table&nbsp;3.4, &#8220;Jolokia Bundle Properties&#8221;</a>. They are mostly the
      same as the <code class="literal">init-param</code> options for
      a Jolokia servlet when used in a JEE WAR artifact.
    </p><div xmlns:xslthl="http://xslthl.sf.net" class="table"><p class="title"><b>Table&nbsp;3.4.&nbsp;Jolokia Bundle Properties</b></p><div class="table-contents"><table id="table-agents-osgi-properties"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
          <td>Property</td>
          <td>Default</td>
          <td>Description</td>
        </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.user</td>
        <td></td>
        <td>User used for authentication with HTTP Basic
        Authentication. If not given, no authentication is used.</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.password</td>
        <td></td>
        <td>Password used for authentication with HTTP Basic
        Authentication.</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.agentContext</td>
        <td>/jolokia</td>
        <td>Context path of the agent servlet</td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.dispatcherClasses</td>
        <td></td>
        <td>
          Class names (comma separated) of request dispatchers used in
          addition to the LocalRequestDispatcher. E.g using a value
          of
          <code class="classname">org.jolokia.jsr160.Jsr160RequestDispatcher</code>
          allows the agent to play the role of a JSR-160 proxy.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.debug</td>
        <td>false</td>
        <td>
          Debugging state after startup. This can be changed via the
          Config MBean (<code class="literal">jolokia:type=Config</code>) at
          runtime
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.debugMaxEntries</td>
        <td>100</td>
        <td>
          Maximum number of entries to keep in the local debug history
          if switched on. This can be changed via the config MBean at
          runtime.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.maxDepth</td>
        <td>0</td>
        <td>
          Maximum depth when traversing bean properties.
          If set to 0, depth checking is disabled
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.maxCollectionSize</td>
        <td>0</td>
        <td>
          Maximum size of collections returned when
          serializing to JSON. When set to 0,
          collections are not truncated.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.maxObjects</td>
        <td>0</td>
        <td>
          Maximum number of objects which are traversed
          when serializing a single response. Use this
          as an airbag to avoid boosting your memory and
          network traffic. Nevertheless, when set to 0
          no limit is imposed.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.historyMaxEntries</td>
        <td>10</td>
        <td>
          Number of entries to keep in the history. This can be changed at
          runtime via the Jolokia config MBean.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.listenForHttpService</td>
        <td>true</td>
        <td>
          If <code class="literal">true</code> the bundle listens for an OSGi
          <code class="literal">HttpService</code> and if available registers an
          agent servlet to it. 
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.httpServiceFilter</td>
        <td></td>
        <td>
           Can be any valid OSGi filter for locating a which
           <code class="classname">org.osgi.service.http.HttpService</code>
           is used to expose the Jolokia servlet. The syntax is that
           used by the <code class="classname">org.osgi.framework.Filter</code>
           which is in turn a <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.ietf.org/rfc/rfc1960.txt" target="_top">
           RFC 1960 based filter</a>. The use of this property
           is described in <a href="agents.html#running-on-glassfish">Section&nbsp;3.2.2, &#8220;Running on Glassfish v3 upwards&#8221;</a>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.useRestrictorService</td>
        <td>false</td>
        <td>
          If <code class="literal">true</code> the Jolokia agent will use any
          <code class="classname">org.jolokia.restrictor.Restrictor</code>
          service for applying access restrictions. If this option is
          <code class="literal">false</code> the standard method of looking up a
          security policy file is used, as described in <a href="security.html#security-policy">Section&nbsp;4.1, &#8220;Policy based security&#8221;</a>.
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td>org.jolokia.detectorOptions</td>
        <td></td>
        <td>
          An optional JSON representation for application specific
          options used by detectors for post-initialization steps. See
          <a href="agents.html#agent-war-init-params" title="Table&nbsp;3.1.&nbsp;Servlet init parameters">Table&nbsp;3.1, &#8220;Servlet init parameters&#8221;</a> for details. 
        </td>
      </tr></table></div></div><p>
      This bundle also exports the service
      <code class="classname">org.jolokia.osgi.servlet.JolokiaContext</code>
      which can be used to obtain context information of the
      registered agent like the context path under which this
      servlet can be reached. Additionally, it exports
      <code class="classname">org.osgi.service.http.HttpContext</code>, which
      is used for authentication. Note that this service is only
      available when the agent servlet is active (i.e. when an
      HttpService is registered). 
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="running-on-glassfish"></a>3.2.2.&nbsp;Running on Glassfish v3 upwards</h3></div></div></div><p>
        You have a couple of choices when running jolokia on
        Glassfish v3 and up, since Glassfish is a both a fully
        fledged JEE container and an OSGi container. If you
        choose to run the <a href="agents.html#agents-war">Section&nbsp;3.1, &#8220;JEE Agent (WAR)&#8221;</a> then it
        is completely straight forward just deploy the war
        in the normal way. If you choose to deploy
        the <a href="agents.html#agents-osgi">Section&nbsp;3.2, &#8220;OSGi Agents&#8221;</a> then you will need
        to configure the <code class="literal">org.jolokia.httpServiceFilter</code>
        option with a filter to select either the Admin
        <code class="classname">HttpService</code> (4848 by default) or the Default
        <code class="classname">HttpService</code> which is where WAR files are
        deployed to.

     </p><p>
        In Glassfish 3.1.2 the OSGi bundle configuration is done in
        <code class="constant">glassfish/conf/osgi.properties</code> in version's
        prior to this the configuration is by default in
        <code class="constant">glassfish/osgi/felix/conf/config.properties</code>
        or if you are using Equinox
        <code class="constant">glassfish/osgi/equinox/configuration/config.ini</code>
     </p><div class="informalexample"><pre class="programlisting">
# Restrict the jolokia http service selection to the admin host
org.jolokia.httpServiceFilter=(VirtualServer=__asadmin)
# Or alternatively to the normal http service use : (VirtualServer=server)
</pre></div><p>
        Deploying the bundle can be either be done by coping the
        <code class="literal">jolokia-osgi.jar</code> into the domain
        <code class="constant">glassfish/domains/&lt;domain&gt;/autodeploy/bundles</code>
        directory or it can be added to all instances by copying the jar
        to <code class="constant">glassfish/modules/autostart</code>
     </p><p>
        By default the agent will be available on <code class="constant">http://localhost:&lt;port&gt;/osgi/jolokia</code>
        rather than <code class="constant">http://localhost:&lt;port&gt;/jolokia</code> as with WAR deployment.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="agents-osgi-bundle"></a>3.2.3.&nbsp;jolokia-osgi-bundle.jar</h3></div></div></div><p>
      The all-in-one bundle includes an implementation of
      <code class="classname">org.osgi.service.http.HttpService</code>,
      i.e. the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/site/apache-felix-http-service.html" target="_top">Felix
      implementation</a>. The HttpService will be registered as
      OSGi service during startup, so it is available for other
      bundles as well. The only package import requirement for this
      bundle is <code class="classname">org.osgi.service.LogService</code>,
      since the Felix Webservice requires this during startup. As
      mentioned above, normally the LogService interface gets exported
      by default in the standard containers, but if not, you need to
      install it e.g. from the OSGi <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://repo1.maven.org/maven2/org/osgi/org.osgi.compendium/4.2.0/org.osgi.compendium-4.2.0.jar" target="_top">compendium
      </a> definitions.
    </p><p>
      This bundle can be configured the same way as the pure bundle as
      described in <a href="agents.html#agents-osgi-pure">Section&nbsp;3.2.1, &#8220;jolokia-osgi.jar&#8221;</a>. Additionally,
      the embedded Felix HttpService can be configured as described in
      its <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/site/apache-felix-http-service.html#ApacheFelixHTTPService-ConfigurationProperties" target="_top">documentation</a>.
      e.g. setting the port to 9090 instead of the default port 8080, a property
      <code class="literal">org.osgi.service.http.port=9090</code> needs to be
      set. This might be useful, if this bundle is used within
      containers which already occupy the default port (Glassfish,
      Eclipse Virgo) but don't expose an OSGi HttpService.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="agents-osgi-servlet"></a>3.2.4.&nbsp;Programmatic servlet registration</h3></div></div></div><p>
      It is also possible to register the Jolokia agent servlet
      manually instead of relying of the OSGi bundle activator which
      comes with the agents. For this use case
      <code class="filename">jolokia-osgi.jar</code> should be used. This
      bundle exports the package
      <code class="classname">org.jolokia.osgi.servlet</code> which includes
      the servlet class <code class="classname">JolokiaServlet</code>. This
      class has three constructors: A default constructor without
      arguments, one with a single
      <code class="classname">BundleContext</code> argument and finally one
      with an additional <code class="classname">Restrictor</code> (see <a href="security.html#security-restrictor">Section&nbsp;4.2, &#8220;Jolokia Restrictors&#8221;</a> for details how access
      restrictions can be applied). The constructor with a
      <code class="classname">BundleContext</code> as its argument has the
      advantage that it will use an OSGi
      <code class="classname">LogService</code> if available and adds various
      OSGi server detectors which adds server information like product
      name and version to the <code class="literal">version</code>
      command. Refer to <a href="protocol.html#version">Section&nbsp;6.2.6, &#8220;Getting the agent version (version)&#8221;</a> for details about the
      server infos provided.
    </p><p>
      Please note that for this use case the bundle
      <code class="classname">org.jolokia.osgi</code> should not be
      <span class="emphasis"><em>started</em></span> but left in the state
      <span class="emphasis"><em>resolved</em></span>. Otherwise, as soon as an OSGi
      HttpService registers, this bundle will try to add yet another
      agent servlet to this service, which is probably not what you
      want. Alternatively, the bundle property
      <code class="literal">org.jolokia.listenForHttpService</code> can be set
      to <code class="literal">false</code> in which case there will be never an
      automatic servlet registration to an HttpService. 
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1128"></a>3.2.5.&nbsp;Restrictor service</h3></div></div></div><p>
      As described in <a href="security.html#security-restrictor">Section&nbsp;4.2, &#8220;Jolokia Restrictors&#8221;</a>, the
      Jolokia agent can use custom restrictors implementing the
      interface
      <code class="classname">org.jolokia.restrictor.Restrictor</code>. If the
      bundle property
      <code class="literal">org.jolokia.useRestrictorService</code> is set to
      true and no restrictor is configured by other means, the agent
      will use one or more OSGi service which register under the name
      <code class="classname">org.jolokia.restrictor.Restrictor</code>. If no
      such service is available, access to the agent is always
      denied. If one such restrictor service is available, the access
      decision is delegated to this service. When more than one
      restrictor service is available, access is ony granted if all of
      them individually grant access. A sample restrictor service as a
      maven project can be found in the Jolokia source at
      <code class="filename">agent/osgi/restrictor-sample</code>. 
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="agents-mule"></a>3.3.&nbsp;Mule Agent</h2></div></div></div><p>
    Jolokia's <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.mulesoft.org" target="_top">Mule</a> agent
    uses Mule's own agent interface for plugging into the ESB running
    in standalone mode. 
  </p><p>
    The agent needs to be included into the Mule configuration as
    shown in the following example, which is the way how to configure 
    the agent for Mule 3:
  </p><div class="informalexample"><pre class="programlisting">
&lt;mule xmlns="http://www.mulesoft.org/schema/mule/core"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:management="http://www.mulesoft.org/schema/mule/management"
    xmlns:spring="http://www.springframework.org/schema/beans" 
    xsi:schemaLocation="
       http://www.mulesoft.org/schema/mule/core 
             http://www.mulesoft.org/schema/mule/core/3.1/mule.xsd
       http://www.springframework.org/schema/beans 
             http://www.springframework.org/schema/beans/spring-beans-2.5.xsd 
       http://www.mulesoft.org/schema/mule/management 
             http://www.mulesoft.org/schema/mule/management/3.1/mule-management.xsd"&gt;

   &lt;!-- .... --&gt;
   &lt;custom-agent name="jolokia-agent" class="org.jolokia.mule.JolokiaMuleAgent"&gt;
      &lt;spring:property name="port" value="8899"/&gt;
   &lt;/custom-agent&gt;
   &lt;management:jmx-server/&gt;
&lt;/mule&gt;
</pre></div><p>
    For Mule 2, the configuration is slightly different since the
    <code class="literal">&lt;custom-agent&gt;</code> is contained in the
    <code class="literal">management</code> namespace for Mule 2
    (<code class="literal">&lt;management:custom-agent&gt;</code>) 
  </p><p>
    This agent knows about the following configuration parameters
  </p><div xmlns:xslthl="http://xslthl.sf.net" class="table"><p class="title"><b>Table&nbsp;3.5.&nbsp;Mule agent configuration options</b></p><div class="table-contents"><table id="agent-mule-config"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
        <td>Parameter</td>
        <td>Description</td>
        <td>Example</td>
      </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">host</code></td>
      <td>
        Hostaddress to which the HTTP server should bind to. 
      </td>        
      <td>
        <code class="constant">InetAddress.getLocalHost()</code>
      </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">port</code></td>
      <td>
        Port the HTTP server should listen to.
      </td>        
      <td>
        <code class="constant">8888</code>
      </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">user</code></td>
      <td>
        Use to authenticate against. This switches on security and
        requires a client to provide a user and password.
      </td>        
      <td>
      </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">password</code></td>
      <td>
        Password to check against when security is switched on. 
      </td>        
      <td>
      </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">debug</code></td>
      <td>
        Debugging state after startup. Can be changed via the <a href="mbeans.html#mbean-config">Section&nbsp;7.1, &#8220;Configuration MBean&#8221;</a> during
        runtime.
      </td>
      <td>
        <code class="constant">false</code>
      </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">historyMaxEntries</code></td>
      <td>
        Entries to keep in the history. Can be changed at
        runtime via the <a href="mbeans.html#mbean-config">Section&nbsp;7.1, &#8220;Configuration MBean&#8221;</a>.
      </td>
      <td>
        <code class="constant">10</code>
      </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">debugMaxEntries</code></td>
        <td>
          Maximum number of entries to keep in the local
          debug history (if enabled). Can be changed via
          the <a href="mbeans.html#mbean-config">Section&nbsp;7.1, &#8220;Configuration MBean&#8221;</a> at runtime.
        </td>
        <td>
          <code class="constant">100</code>
        </td>
      </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">maxDepth</code></td>
      <td>
        Maximum depth when traversing bean properties.
        If set to 0, depth checking is disabled
        </td>
        <td>
          <code class="constant">5</code>
        </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">maxCollectionSize</code></td>
        <td>
          Maximum size of collections returned when
          serializing to JSON. When set to 0,
          collections are never truncated.
        </td>
        <td>
          <code class="constant">0</code>
        </td>
    </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
      <td><code class="constant">maxObjects</code></td>
      <td>
        Maximum number of objects which are traversed
        when serializing a single response. Use this
        as an airbag to avoid boosting your memory and
        network traffic. Nevertheless, when set to 0
        no limit is imposed.
      </td>
      <td>
        <code class="constant">10000</code>
      </td>
    </tr></table></div></div><p>
    The context under which the agent is reachable is fixed to
    <code class="literal">/jolokia</code>. As an alternative to this Mule agent,
    the <a href="agents.html#agents-jvm">Section&nbsp;3.4, &#8220;JVM Agent&#8221;</a> can be used for
    Mule, too. This agent also knows about SSL encryption and
    authentication.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a name="agents-jvm"></a>3.4.&nbsp;JVM Agent</h2></div></div></div><p>
    The JVM agent is right agent when it comes to instrument an
    arbitrary Java application which is not covered by the other
    agents. This agent can be started by any Java program by
    providing certain startup options to the JVM. Or it can be
    dynamically attached (and detached) to an already running Java
    process. This universal agent uses the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://download.oracle.com/javase/6/docs/technotes/guides/jvmti/index.html" target="_top">JVM
    agent API</a> and is available for every Sun/Oracle JVM 1.6
    and later. 
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jvm-agent"></a>3.4.1.&nbsp;Jolokia as JVM Agent</h3></div></div></div><p>
      The JVM agent uses the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://download.oracle.com/javase/6/docs/technotes/guides/jvmti/index.html" target="_top">JVM
      Agent interface</a> for linking into any JVM. Under the
      hood it uses an HTTP-Server, which is available on every
      Oracle/Sun JVM from verion 1.6 upwards.
    </p><div xmlns:xslthl="http://xslthl.sf.net" class="sidebar-border"><div class="sidebar"><p class="title"><b></b></p>
      The JDK embedded HTTP-Server is not the fastest one (it is used
      e.g. for the JAXWS reference implementation), but for our
      monitoring needs the performance is sufficient. it is
      sufficient for our needs. There are several configuration
      options for tuning the HTTP server's performance. See below for
      details. 
    </div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jvm-agent-installation"></a>3.4.1.1.&nbsp;Installation</h4></div></div></div><p>
        This agent gets installed by providing a single startup option
        <code class="literal">-javaagent</code> when starting the Java process. 
      </p><pre class="programlisting">
java -javaagent:agent.jar=port=7777,host=localhost</pre><p>
        <code class="filename">agent.jar</code> is the filename of the Jolokia
        JVM agent. Options can be appended as a comma separated
        list. The available options are the same as described in <a href="agents.html#agent-war-init-params" title="Table&nbsp;3.1.&nbsp;Servlet init parameters">Table&nbsp;3.1, &#8220;Servlet init parameters&#8221;</a> plus the one described in
        table <a href="agents.html#agent-jvm-config" title="Table&nbsp;3.6.&nbsp;JVM agent configuration options">Table&nbsp;3.6, &#8220;JVM agent configuration options&#8221;</a>. If an options
        contains a comma, an equal sign or a backslash, it must be
        escaped with a backslash. 
      </p><div xmlns:xslthl="http://xslthl.sf.net" class="table"><p class="title"><b>Table&nbsp;3.6.&nbsp;JVM agent configuration options</b></p><div class="table-contents"><table id="agent-jvm-config"><thead xmlns:xi="http://www.w3.org/2001/XInclude"><tr>
            <td>Parameter</td>
            <td>Description</td>
            <td>Example</td>
          </tr></thead><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">agentContext</code></td>
          <td>
            Context under which the agent is deployed. The full URL
            will be <code class="literal">protocol://host:port/agentContext</code>
          </td>        
          <td>
            <code class="constant">/jolokia</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
        <td><code class="constant">host</code></td>
        <td>
          Hostaddress to which the HTTP server should bind to. 
        </td>        
        <td>
          <code class="constant">InetAddress.getLocalHost()</code>
        </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">port</code></td>
          <td>
            Port the HTTP server should listen to.
          </td>        
          <td>
            <code class="constant">8778</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">protocol</code></td>
          <td>
            HTTP protocol to use. Should be either <code class="literal">http</code>
            or <code class="literal">https</code>. For the SSL stack there are various
            additional configuration options. 
          </td>        
          <td>
            <code class="constant">http</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">backlog</code></td>
          <td>
            Size of request backlog before requests get discarded. 
          </td>        
          <td>
            <code class="constant">10</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">executor</code></td>
          <td>
            Threading model of the HTTP server:
            <div class="variablelist"><dl><dt><span class="term"><code class="literal">fixed</code></span></dt><dd><p>
                    Thread pool with a fixed
                    number of threads (see also
                    <code class="constant">threadNr</code>)
                  </p></dd><dt><span class="term"><code class="literal">cached</code></span></dt><dd><p>
                    Cached thred pool which
                    creates threads on demand
                  </p></dd><dt><span class="term"><code class="literal">single</code></span></dt><dd><p>
                    A single thread only
                  </p></dd></dl></div>
          </td>        
          <td>
            <code class="constant">single</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">threadNr</code></td>
          <td>
            Number of threads to be used when the
            <code class="constant">fixed</code> execution model is chosen. 
          </td>        
          <td>
            <code class="constant">5</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">keystore</code></td>
          <td>
            Path to the SSL keystore to use (https only)
          </td>        
          <td>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">keystorePassword</code></td>
          <td>
            Keystore password (https only)
          </td>        
          <td>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">useSslClientAuthentication</code></td>
          <td>
            Whether client certificates should be used for
            authentication (https only). (<code class="constant">true</code> or
            <code class="constant">false</code>). 
          </td>        
          <td>
            <code class="constant">false</code>
          </td>
        </tr><tr xmlns:xi="http://www.w3.org/2001/XInclude">
          <td><code class="constant">config</code></td>
          <td>
            Path to a properties file from where the configuration
            options should be read. Such a property file can contain
            the configuration options as described here as key value
            pairs (except for the <code class="constant">config</code> property
            of course :)
          </td>        
          <td>
        </td>
        </tr></table></div></div><p>
        Upon sucessful startup the agent will print out a success
        message with the full URL which can be used by clients for
        contacting the agent. 
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jvm-attach"></a>3.4.2.&nbsp;Attaching a Jolokia agent on the fly</h3></div></div></div><p>
      A Jolokia agent can be attached to any running Java process as
      long as the user has sufficient access privileges for
      accessing the process.  This agent uses the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://download.oracle.com/javase/6/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html" target="_top">Java 
      attach API</a> for dynamically attaching and detaching to
      and from the process. It works similar to JConsole connecting
      to a local process. The Jolokia advantage is, that after the
      start of the agent, it can be reached over the network.
    </p><p>
      The JAR containing the JVM  agent also contains a client
      application which can be reached via the
      <code class="literal">-jar</code> option. Call it with
      <code class="literal">--help</code> to get a short usage information:
    </p><pre class="programlisting">
$ java -jar jolokia-jvm-1.0.1-agent.jar --help

Jolokia Agent Launcher
======================

Usage: java -jar jolokia-jvm-1.0.1-SNAPSHOT-agent.jar [options] &lt;command&gt; &lt;pid/regexp&gt;

where &lt;command&gt; is one of
    start     -- Start a Jolokia agent for the process specified
    stop      -- Stop a Jolokia agent for the process specified
    status    -- Show status of an (potentially) attached agent
    toggle    -- Toggle between start/stop (default when no command is given)
    list      -- List all attachable Java processes (default when no argument is given at all)

[options] are used for providing runtime information for attaching the agent:

    --host &lt;host&gt;                 Hostname or IP address to which to bind on
                                  (default: InetAddress.getLocalHost())
    --port &lt;port&gt;                 Port to listen on (default: 8778)
    --agentContext &lt;context&gt;      HTTP Context under which the agent is reachable (default: /jolokia)
    --user &lt;user&gt;                 User used for Basic-Authentication
    --password &lt;password&gt;         Password used for Basic-Authentication
    --quiet                       No output. "status" will exit with code 0 if the agent is running, 1 otherwise
    --verbose                     Verbose output
    --executor &lt;executor&gt;         Executor policy for HTTP Threads to use (default: single)
                                  "fixed"  -- Thread pool with a fixed number of threads (default: 5)
                                  "cached" -- Cached Thread Pool, creates threads on demand
                                  "single" -- Single Thread
    --threadNr &lt;nr threads&gt;       Number of fixed threads if "fixed" is used as executor
    --backlog &lt;backlog&gt;           How many request to keep in the backlog (default: 10)
    --protocol &lt;http|https&gt;       Protocol which must be either "http" or "https" (default: http)
    --keystore &lt;keystore&gt;         Path to keystore (https only)
    --keystorePassword &lt;pwd&gt;      Password to the keystore (https only)
    --useSslClientAuthentication  Use client certificate authentication (https only)
    --debug                       Switch on agent debugging
    --debugMaxEntries &lt;nr&gt;        Number of debug entries to keep in memory which can be fetched from the Jolokia MBean
    --maxDepth &lt;depth&gt;            Maximum number of levels for serialization of beans (default: null)
    --maxCollectionSize &lt;size&gt;    Maximum number of element in collections to keep when serializing the response (default: null)
    --maxObjects &lt;nr&gt;             Maximum number of objects to consider for serialization (default: maxObjects)
    --policyLocation &lt;url&gt;        Location of a Jolokia policy file
    --mbeanQualifier &lt;qualifier&gt;  Qualifier to use when registering Jolokia internal MBeans
    --config &lt;configfile&gt;         Path to a property file from where to read the configuration
    --help                        This help documentation

&lt;pid/regexp&gt; can be either a numeric process id or a regular expression. A regular expression is matched
against the processes' names (ignoring case) and must be specific enough to select exactly one process.

If no &lt;command&gt; is given but only a &lt;pid&gt; the state of the Agent will be toggled
between "start" and "stop"

If neither &lt;command&gt; nor &lt;pid&gt; is given, a list of Java processes along with their IDs
is printed

For more documentation please visit www.jolokia.org</pre><p>
      Every option described in <a href="agents.html#agent-jvm-config" title="Table&nbsp;3.6.&nbsp;JVM agent configuration options">Table&nbsp;3.6, &#8220;JVM agent configuration options&#8221;</a>
      is reflected by a command line option for the
      launcher. Additionally, the option <code class="literal">--quiet</code>
      can be used to keep the launcher silent and
      <code class="literal">--verbose</code> for adding some extra logging. 
    </p><p>
      The launcher knows various operational modes, which needs to
      be provided as a non-option argument and possibly require an
      extra argument. 
    </p><div class="variablelist"><dl><dt><span class="term"><code class="literal">start</code></span></dt><dd><p>
            Use this to attach an agent to an already running, local
            Java process. The additional argument is either the
            <span class="emphasis"><em>process id</em></span> of the Java process to
            attach to or a <span class="emphasis"><em>regular expression</em></span>
            which is matched against the Java processes names. In the
            later case, exactly one process must match, otherwise an
            exception is raised. The command will return with an
            return code of 0 if an agent has been started. If the
            agent is already running, nothing happens and the launcher
            returns with 1. The URL of the Agent will be printed to
            standard out on an extra line except when the
            <code class="literal">--quiet</code> option is used.
          </p></dd><dt><span class="term"><code class="literal">stop</code></span></dt><dd><p>
              Command for stopping an running and dynamically attached
              agent. The required argument is the Java process id or
              an regular expression as described for the
              <code class="literal">start</code> command. If the agent could be
              stopped, the launcher exits with 0, it exits with 1 if
              there was no agent running.
          </p></dd><dt><span class="term"><code class="literal">toggle</code></span></dt><dd><p>
            Starts or stops an dynamically attached agent,
            dependening on its current state. The Java process ID is
            required as an additional argument. If an agent is
            running, <code class="literal">toggle</code> will stop it (and
            vice versa). The launcer returns with an exit code of 0
            except when the operation fails. When the agent is
            started, the full agent's URL is printed to standard
            out. <code class="literal">toggle</code> is the default command
            when only a numeric process id is given as argument or a
            regular expression which <span class="emphasis"><em>not</em></span> the same
            as a known command.
          </p></dd><dt><span class="term"><code class="literal">status</code></span></dt><dd><p>
            Command for showing the current agent status for a given
            process. The process id or a regular expresssion is
            required. The launcer will return with 0 when the agent is
            running, otherwise with 1.
          </p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>
            List all local Java processes in a table with the
            process id and the description as columns. This is the
            default command if no non-option argument is given at
            all. <code class="literal">list</code> returns with 0 upon normal
            operation and with 1 otherwise.
          </p></dd></dl></div><p>
      The launcher is especially suitable for
      <span class="emphasis"><em>one-shot</em></span>, <span class="emphasis"><em>local</em></span>
      queries. For example, a simple shell script for printing out
      the memory usage of a local Java process, including
      (temporarily) attaching an Jolokia agent looks simply like in
      the following example. With a complete client library like <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.jmxp4perl.org" target="_top">Jmx4Perl</a> even more one
      shot scripts are possible<sup>[<a name="rest-comment" href="#ftn.rest-comment">6</a>]</sup>.
    </p><pre class="programlisting">
#!/bin/sh

url=`java -jar agent.jar start $1 | tail -1`

memory_url="${url}read/java.lang:type=Memory/HeapMemoryUsage"
used=`wget -q -O - "${memory_url}/used" | sed 's/^.*"value":\([0-9]*\).*$/\1/'`
max=`wget -q -O - "${memory_url}/max" | sed 's/^.*"value":\([0-9]*\).*$/\1/'`
usage=$((${used}*100/${max}))
echo "Memory Usage: $usage %"

java -jar agent.jar --quiet stop $1</pre></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e149" href="#d0e149">1</a>] </sup>
        Although the proxy mode is available for all four agents, you
        are normally free to setup the proxy environment. The
        recommendation here is the war-agent for which very
        lightweight servlet container exists. Tomcat or Jetty are both
        a perfect choice for a Jolokia proxy server.
      </p></div><div class="footnote"><p><sup>[<a name="ftn.d0e168" href="#d0e168">2</a>] </sup>
            Of course, there is much more to OSGi, a platform and
            programing model which I <span class="emphasis"><em>really</em></span>
            like. This is my personal pet agent, so to speak ;-).
          </p></div><div class="footnote"><p><sup>[<a name="ftn.d0e189" href="#d0e189">3</a>] </sup>
           <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://answers.yahoo.com/question/index?qid=20071216082739AAfkxnm" target="_top">What is the proper plural form of "bus"?</a>
          </p></div><div class="footnote"><p><sup>[<a name="ftn.d0e205" href="#d0e205">4</a>] </sup>
          You could even instrument a JEE application server this way,
          however this is not recommended.
        </p></div><div class="footnote"><p><sup>[<a name="ftn.d0e576" href="#d0e576">5</a>] </sup>
        Replace
        <code class="classname">org.jolokia.osgi.http.AgentServlet</code> with
        <code class="classname">org.jolokia.http.AgentServlet</code> to use
        the servlet in a non-OSGi environment.
      </p></div><div class="footnote"><p><sup>[<a name="ftn.rest-comment" href="#rest-comment">6</a>] </sup>And in fact, some support for launching this dynamic
      agent is planned for a forthcoming release of jmx4perl.</p></div></div></div><div class="navfooter"><div>
        <div class="navbar"><a xmlns:xslthl="http://xslthl.sf.net" href="architecture.html" title="Chapter&nbsp;2.&nbsp;Architecture">上一页</a><span>|</span><a xmlns:xslthl="http://xslthl.sf.net" href="index.html" title="Jolokia - Reference Documentation">目录</a><span>|</span><a xmlns:xslthl="http://xslthl.sf.net" href="security.html" title="Chapter&nbsp;4.&nbsp;Security">下一页</a></div></div></div></body></html>